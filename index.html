<!DOCTYPE html>
<html>
<head>
	<title>Zkillboard Checker</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tinysort/2.3.6/tinysort.js"></script>

	<link rel="stylesheet" type="text/css" href="stylin.css"/>
</head>
<body>
<div class="container" id="test" style="margin-top: 6px;">
  <div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon1">Character name</span>
  </div>
  <input type="text" class="form-control" placeholder="El'Miner" aria-label="Username" aria-describedby="basic-addon1" id="char-name-field">
</div>
  <div class="row">
      <div class="card" style="width: 18rem; max-height: 500px;">
        <img class="card-img-top" src="" alt="Character portrait" id="char-portrait">
        <div class="card-body">
          <h5 class="card-title"><div class="container" id="char-name"></div></h5>
          <div class="container" id="alliance"></div>
          <div class="container" id="corporation"></div>
          <div class="container" id="sec-status"></div>
          <div class="container" id="birth"></div>
        </div>
	  </div>
	<div class="col" id="empty-kb" style="display: none"><div class="alert alert-danger" role="alert">Killboard is empty!</div></div>
    <div class="col" id="middle-column">
	  <div class="container" id="cynoes">
		<div id="out-of">Out of <span id="killmails-checked"></span> and <span id="lossmails-checked"></span> checked:</div>
		<div><span id="cyno-percent"></span> (<span id="cyno-percent-recent"></span>)</div>
		<div class="btn-group">
			<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Losses with cynoes fitted 
			<span class="badge badge-danger" id="cyno-count"></span><span class="sr-only">cynoes</span><span class="caret"></span></button>
			<ul class="dropdown-menu scrollable-menu" role="menu" id="cyno-list"></ul>
		</div>
		<div><span id="supers-percent"></span> (<span id="supers-percent-recent"></span>)</div>
		<div class="btn-group">
				<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Kills with supers 
				<span class="badge badge-danger" id="super-count"></span><span class="sr-only">supers</span><span class="caret"></span></button>
				<ul class="dropdown-menu scrollable-menu" role="menu" id="super-list"></ul>
		</div>
	  </div>
	  <div class="container" style="margin-top: 5px">
		  	Most used ships were:
			<div class="row">
					<div class="col-sm" id="0-most-used" style="display: none">
						<a target="_blank" href="" id="0-most-used-link">
							<img id="0-most-used-preview" src="" class="img-thumbnail mx-auto d-block">
							<div class="text-center" id="0-most-used-text"></div>
						</a>
						<div class="text-center" id="0-most-used-amount"></div>
					</div>
					<div class="col-sm" id="1-most-used" style="display: none">
						<a target="_blank" href="" id="1-most-used-link">
							<img id="1-most-used-preview" src="" class="img-thumbnail mx-auto d-block">
							<div class="text-center" id="1-most-used-text"></div>
						</a>
						<div class="text-center" id="1-most-used-amount"></div>
					</div>
					<div class="col-sm" id="2-most-used" style="display: none">
						<a target="_blank" href="" id="2-most-used-link">
							<img id="2-most-used-preview" src="" class="img-thumbnail mx-auto d-block">
							<div class="text-center" id="2-most-used-text"></div>
						</a>
						<div class="text-center" id="2-most-used-amount"></div>
					</div>
			  </div>
	  </div>
    </div>
    <div class="col" id="right-column">
      <div id="flies-with">Flies with:</div>
      <div class="container" id="friends"><ul class="list-group"></ul></div>
    </div>
  </div>
</div>
<script type="text/javascript">
	$("#char-name-field").keypress(function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13'){
        	getCharID($("#char-name-field").val(), function(char_id)
        	{
			$("#char-portrait").attr("src", `https://imageserver.eveonline.com/Character/${char_id}_256.jpg`);
			getBasicInfo(char_id);
			isKillboardEmpty(char_id).then((value) => {
			if(value == true)
			{
				$("#middle-column").css("display", "none");
				$("#right-column").css("display", "none");
				$("#empty-kb").css("display", "block");
			}
			else
			{
				checkLosses(char_id);
			  	checkKills(char_id);
				$("#middle-column").css("display", "block");
				$("#right-column").css("display", "block");
				$("#empty-kb").css("display", "none");
			}
			})
        	})
        }
    });

	$("#cyno-list").parent().on('show.bs.dropdown', function(){
		tinysort("#cyno-list>li", {order: 'desc', selector: 'a', data: 'time'});
	})

	$("#super-list").parent().on('show.bs.dropdown', function(){
		tinysort("#super-list>li", {order: 'desc', selector: 'a', data: 'time'});
	})

    function getBasicInfo(char_id)
    {
    	$.getJSON(`https://esi.evetech.net/latest/characters/${char_id}/`, function(char_data){

    		$("#char-name, #alliance, #corporation, #sec-status, #birth").empty();

			$("#char-name").html(`<a target="_blank" href="https://zkillboard.com/character/${char_id}/">${char_data.name}</a>`);

			if(char_data.alliance_id != undefined)
			{
				$.getJSON(`https://esi.evetech.net/latest/alliances/${char_data.alliance_id}/`, function(data){
				$("#alliance").html(`<a target="_blank" href="https://zkillboard.com/alliance/${char_data.alliance_id}/">${data.name}</a> &lt;${data.ticker}&gt;`);
			})
			}
			$.getJSON(`https://esi.evetech.net/latest/corporations/${char_data.corporation_id}/`, function(data){
				$("#corporation").html(`<a target="_blank" href="https://zkillboard.com/corporation/${char_data.corporation_id}/">${data.name}</a> [${data.ticker}]`);
			});

			var sec_stat_class;
			if(parseFloat(char_data.security_status) > 2.5)
			{
				sec_stat_class = "sec-status-krab";
			}
			else if(parseFloat(char_data.security_status) < -1.0)
			{
				sec_stat_class = "sec-status-pvp";
			}
			else
			{
				sec_stat_class = "sec-status-neutral";
			}
			$("#sec-status").html(`Security status: <span class="${sec_stat_class}">${(char_data.security_status).toFixed(2)}</span>`);

			$("#birth").html(`<a target="_blank" href="https://evewho.com/pilot/${encodeURI(char_data.name)}">${moment(char_data.birthday).format('YYYY')} character</a>`);
		});
    }

    function checkLosses(char_id)
    {
		$.ajax({
			    cache: true,
			    url: `https://zkillboard.com/api/losses/characterID/${char_id}/`,
			    dataType: "json",
			    success: function(data) {
			    	$("#cyno-list").empty();
					$("#lossmails-checked").text(`${data.length} lossmails`);
					var total_cynoes = 0;
					var total_cynoes_recently = 0;
					var today = moment();
	      			data.forEach(function(killmail){
	      				var ship = killmail.victim.ship_type_id;
						var rookie_ships = [606, 588, 601, 596];
	      				if((killmail.victim.items.some(module => (module.item_type_id == 28646 /*covert cyno*/ || module.item_type_id == 21096 /*normal cyno*/) && (module.flag > 26 && module.flag < 35))) && (!rookie_ships.includes(ship)))
	      				{
							total_cynoes += 1;
							if(today.diff(moment(killmail.killmail_time), 'months') < 3)
							{
								total_cynoes_recently += 1;
							}
	      					getShipName(ship, function(name){
								$("#cyno-list").append(`<li><a target="_blank" class="dropdown-item" data-time=${killmail.killmail_time} href="https://zkillboard.com/kill/${killmail.killmail_id}/">${name} @ ${moment(killmail.killmail_time).utc().format('MMMM Do YYYY')}</a></li>`);
	      					});
	      				}
	      			});
					var pod_ship_id = [670, 33328];
					var lossmails_recently = data.filter(lossmail => (today.diff(moment(lossmail.killmail_time), 'months') < 3) && (!pod_ship_id.includes(lossmail.victim.ship_type_id))).length;
					$("#cyno-percent-recent").text(`${getPercent(total_cynoes_recently, lossmails_recently)} % recently`);
					$("#cyno-count").text(total_cynoes);
					if(total_cynoes == 0)
					{
						$("#cyno-list").append(`<li class="dropdown-item disabled">No ships with cynoes lost.</li>`);
					}
					$("#cyno-percent").text(`${getPercent(total_cynoes, data.length)}% had cyno`);
	   			}
				});
    }

    function checkKills(char_id)
    {
    	$.ajax({
			cache: true,
			url: `https://zkillboard.com/api/kills/characterID/${char_id}/`,
			dataType: "json",
			success: function(data){
				$("#friends>ul").empty();
				$("#super-list").empty();
				$("#killmails-checked").text(`${data.length} killmails`)
				var alliances = new Array();
				var number_of_killmails = data.length;
				
				data.forEach(function(element){
					element.attackers.forEach(function(attacker){
						if(alliances.find(x => x.id == attacker.alliance_id) == undefined)
						{
							alliances.push({id: attacker.alliance_id, kills: 1});
						}
						else
						{
							alliances.find(x => x.id == attacker.alliance_id).kills += 1;
						}
					})
				})

				formFriendsList(data, alliances, char_id).then((value) => {updateFriendsList(value)});

				var supers = [3514, 22852, 23913, 23917, 23919, 42125];
				var titans = [671, 3764, 11567, 23773, 42126, 42241, 45649];
				var killmails_with_supers = 0;
				var killmails_with_supers_recently = 0;
				var today = moment();
				data.forEach(function(killmail){
					if(killmail.attackers.some(x => supers.includes(x.ship_type_id) || titans.includes(x.ship_type_id)))
					{
						killmails_with_supers += 1;
						if(today.diff(moment(killmail.killmail_time), 'months') < 3)
						{
							killmails_with_supers_recently += 1;
						}
						getShipName(killmail.victim.ship_type_id, function(name){
								$("#super-list").append(`<li><a target="_blank" class="dropdown-item" data-time=${killmail.killmail_time} href="https://zkillboard.com/kill/${killmail.killmail_id}/">${name} @ ${moment(killmail.killmail_time).utc().format('MMMM Do YYYY')}</a></li>`);
	      				});
					}
				});
				var killmails_recent = data.filter(killmail => today.diff(moment(killmail.killmail_time), 'months') < 3).length;
				$("#supers-percent-recent").text(`${getPercent(killmails_with_supers_recently, killmails_recent)}% recently`);
				$("#supers-percent").text(`${getPercent(killmails_with_supers, data.length)}% had supers or titans`);
				$("#super-count").text(killmails_with_supers);
				if(killmails_with_supers == 0)
				{
					$("#super-list").append(`<li class="dropdown-item disabled">No killmails with supers found.</li>`);
				}
				getAndUpdateMostUsedShips(data, char_id);
			}
		});
    }

	function getAndUpdateMostUsedShips(data, char_id)
	{
		var used_ships = new Array();
		data.forEach(function(killmail){
			var ship_used_on_this_killmail = killmail.attackers.find(x => x.character_id == char_id).ship_type_id;
			if(used_ships.find(x => x.id == ship_used_on_this_killmail) == undefined)
			{
				used_ships.push({id: ship_used_on_this_killmail, kills: 1})
			}
			else
			{
				used_ships.find(x => x.id == ship_used_on_this_killmail).kills += 1;
			}
		})
		sortShipsByMostUsed(used_ships);
		updateMostUsedShips(used_ships, char_id);
	}

	function sortShipsByMostUsed(ships)
	{
		return ships.sort(function(a,b){
			return b.kills - a.kills;
		})
	}

	function updateMostUsedShips(ships, char_id)
	{
		for (let index = 0; index < 3; index++) {
			$(`#${index}-most-used`).css("display", "none");
			if(!(ships[index] === undefined))
			{
				$(`#${index}-most-used-preview`).attr("src", `https://imageserver.eveonline.com/Render/${ships[index].id}_128.png`);	
				$(`#${index}-most-used-amount`).text(`(${ships[index].kills} kills)`);
				getShipName(ships[index].id, function(ship_name){
					$(`#${index}-most-used-text`).text(ship_name);
					$(`#${index}-most-used-link`).attr("href", `https://zkillboard.com/character/${char_id}/losses/shipID/${ships[index].id}/`)
					$(`#${index}-most-used`).css("display", "block");
				});
			}
		}
	}

    function getCharID(char_name, callback)
    {
    	$.getJSON(`https://esi.evetech.net/latest/search/?categories=character&datasource=tranquility&search=${encodeURI(char_name)}&strict=true`, function(data){
    		callback(data.character[0]);
    	})	
    }

    function getShipName(ship_id, callback)
    {
    	$.getJSON(`https://esi.evetech.net/latest/universe/types/${ship_id}/`, function(data){
    		callback(data.name);
    	})
    }

	function getPercent(number, total)
	{
		var percent = Math.round(number/total*100, 1);
		if(isNaN(percent))
		{
			return 0;
		}
		else
		{
			return percent;
		}
	}

	function isKillboardEmpty(char_id)
	{
		return new Promise((resolve) => {
			$.getJSON(`https://zkillboard.com/api/stats/characterID/${char_id}/`).then(function(data){
			resolve((data.shipsDestroyed === undefined) && (data.shipsLost === undefined));
			})
		})
	}

	function updateFriendsList(html)
	{
		$("#friends>ul").append(html);
		tinysort("#friends>ul>li", {order: 'desc', selector: 'a', data: 'number'});
	}

	function formFriendsList(data, alliances, char_id)
	{
		var promises = [];
		var friends_list_html = "";
		var number_of_killmails = data.length;

		alliances.forEach(function(element){
			if(element.id != undefined)
			{
				var alliance_on_killmails = 0;
				data.forEach(function(killmail){
					if(killmail.attackers.some(x => x.alliance_id == element.id && x.character_id != char_id))
					{
						alliance_on_killmails += 1;
					}	
				})
				if(alliance_on_killmails/number_of_killmails > 0.2)
				{
					promises.push(new Promise((resolve) => {
						$.getJSON(`https://esi.evetech.net/latest/alliances/${element.id}/`).then(function(alliance_response){
							friends_list_html += `<li class="list-group-item"><a target="_blank" data-number=${alliance_on_killmails} href="https://zkillboard.com/alliance/${element.id}/">${alliance_response.name}</a> &lt;${alliance_response.ticker}&gt; <span class="font-weight-light">(on ${alliance_on_killmails} killmails)</span> </br></li>`;
							resolve();
						})
					}))
				}
			}
		});

		return Promise.all(promises).then(() => {return friends_list_html});
	}


	$(document).ready(function(){
		var char_id = 90659102;

		$("#char-portrait").attr("src", `https://imageserver.eveonline.com/Character/${char_id}_256.jpg`);

		getBasicInfo(char_id);

		checkLosses(char_id);
		
		checkKills(char_id)
	});
</script>
</body>
</html>